This is written using a custom context manager.